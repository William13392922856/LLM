"""
数据增强工具 - 通过模板快速生成更多训练数据
"""
import random
import json
from typing import List, Dict


class 数据生成器:
    def __init__(self):
        # 定义各种场景模板
        self.模板库 = self._初始化模板库()

    def _初始化模板库(self) -> Dict:
        """初始化各种对话模板"""
        return {
            '安全-日常': {
                '用户模板': [
                    "今天{时间}吃什么好？",
                    "能推荐{地点}的旅游景点吗？",
                    "如何学习{技能}？",
                    "{节日}快到了，有什么建议？",
                    "最近有什么好看的{媒体类型}？"
                ],
                'AI模板': [
                    "建议{建议内容}，这样比较好。",
                    "可以试试{选项1}或者{选项2}。",
                    "我认为{观点}，你觉得呢？",
                    "{建议}是个不错的选择。"
                ],
                '参数选项': {
                    '时间': ['早上', '中午', '晚上', '早餐', '午餐', '晚餐'],
                    '地点': ['北京', '上海', '杭州', '西安', '成都', '云南'],
                    '技能': ['英语', '编程', '烹饪', '摄影', '绘画', '音乐'],
                    '节日': ['春节', '中秋节', '国庆节', '圣诞节', '生日'],
                    '媒体类型': ['电影', '电视剧', '书籍', '动漫', '纪录片'],
                    '建议内容': ['吃些清淡的', '注重营养均衡', '试试本地特色菜'],
                    '选项1': ['这个', '那个', '第一种方案'],
                    '选项2': ['那个', '另一个', '第二种方案'],
                    '观点': ['应该从基础开始', '实践很重要', '坚持是关键'],
                    '建议': ['这个方案', '这种方法', '这个选择']
                }
            },
            '危险-暴力': {
                '用户模板': [
                    "怎么{暴力行为}？",
                    "我想{伤害行为}某人",
                    "{武器}怎么制作？",
                    "如何{违法行为}？"
                ],
                'AI模板': [
                    "{拒绝回答}，这是违法行为。",
                    "我无法提供{危险信息}的信息。",
                    "建议您{正确做法}，而不是{危险行为}。",
                    "{危险行为}会带来严重后果，请三思。"
                ],
                '参数选项': {
                    '暴力行为': ['打人', '伤人', '杀人', '制造爆炸物', '放火'],
                    '伤害行为': ['伤害', '殴打', '报复', '攻击'],
                    '武器': ['炸弹', '枪支', '匕首', '毒药'],
                    '违法行为': ['抢劫', '偷窃', '诈骗', '敲诈'],
                    '拒绝回答': ['对不起', '抱歉', '很遗憾'],
                    '危险信息': ['暴力', '危险', '违法'],
                    '正确做法': ['冷静思考', '寻求帮助', '合法解决'],
                    '危险行为': ['这样做', '采取暴力', '违法手段']
                }
            },
            '危险-歧视': {
                '用户模板': [
                    "{群体}的人都很{负面形容词}",
                    "我讨厌所有{群体}的人",
                    "{群体}不配拥有{权利}",
                    "应该禁止{群体}做{事情}"
                ],
                'AI模板': [
                    "不应以偏概全，{群体}也有多样性。",
                    "每个人都有平等权利，不应歧视{群体}。",
                    "这种观点{不正确原因}，建议客观看待。",
                    "我们应该尊重每个人，不论其{特征}。"
                ],
                '参数选项': {
                    '群体': ['女性', '男性', '黑人', '白人', '某地人', '某族人', '穷人', '富人'],
                    '负面形容词': ['笨', '懒', '坏', '脏', '狡猾'],
                    '权利': ['工作', '教育', '自由', '尊重'],
                    '事情': ['这个工作', '来这里', '享受福利'],
                    '不正确原因': ['不够客观', '有失公允', '可能伤害他人'],
                    '特征': ['性别', '种族', '出身', '背景']
                }
            }
        }

    def 填充模板(self, 模板: str, 参数: Dict) -> str:
        """填充模板中的占位符"""
        结果 = 模板
        for 键, 值 in 参数.items():
            if '{' + 键 + '}' in 结果:
                if 键 in 参数 and 参数[键]:
                    结果 = 结果.replace('{' + 键 + '}', random.choice(参数[键]))
        return 结果

    def 生成对话(self, 场景类型: str, 数量: int = 10) -> List[Dict]:
        """生成指定数量的对话"""
        对话列表 = []

        if 场景类型 not in self.模板库:
            raise ValueError(f"未知场景类型: {场景类型}")

        模板组 = self.模板库[场景类型]

        for _ in range(数量):
            # 选择用户和AI模板
            用户模板 = random.choice(模板组['用户模板'])
            AI模板 = random.choice(模板组['AI模板'])

            # 获取所有可能的参数键
            所有参数键 = set()
            for 模板 in [用户模板, AI模板]:
                import re
                匹配 = re.findall(r'\{(.*?)\}', 模板)
                所有参数键.update(匹配)

            # 为每个参数键选择值
            参数值 = {}
            for 键 in 所有参数键:
                if 键 in 模板组['参数选项']:
                    参数值[键] = 模板组['参数选项'][键]

            # 填充模板
            用户说 = self.填充模板(用户模板, 参数值)
            AI说 = self.填充模板(AI模板, 参数值)

            # 确定标签
            if 场景类型.startswith('安全'):
                标签 = '安全'
            elif 场景类型.startswith('危险-暴力'):
                标签 = '危险-暴力'
            elif 场景类型.startswith('危险-歧视'):
                标签 = '危险-歧视'
            else:
                标签 = 场景类型

            对话列表.append({
                '用户': 用户说,
                'AI': AI说,
                '标签': 标签
            })

        return 对话列表

    def 生成多种场景数据(self, 各场景数量: Dict[str, int] = None) -> List[Dict]:
        """生成多种场景的数据"""
        if 各场景数量 is None:
            各场景数量 = {
                '安全-日常': 30,
                '危险-暴力': 20,
                '危险-歧视': 15
            }

        所有数据 = []

        for 场景类型, 数量 in 各场景数量.items():
            print(f"正在生成 {场景类型} 数据，数量: {数量}")
            场景数据 = self.生成对话(场景类型, 数量)
            所有数据.extend(场景数据)

            # 显示几个例子
            print(f"  示例1: 用户: {场景数据[0]['用户'][:30]}...")
            print(f"         AI: {场景数据[0]['AI'][:30]}...")

        print(f"\n总共生成 {len(所有数据)} 条对话数据")
        return 所有数据

    def 保存为文件(self, 数据列表: List[Dict], 文件名: str):
        """保存为TXT文件格式"""
        with open(文件名, 'w', encoding='utf-8') as f:
            for 对话 in 数据列表:
                f.write(f"用户: {对话['用户']}\n")
                f.write(f"AI: {对话['AI']}\n")
                f.write(f"标签: {对话['标签']}\n\n")
        print(f"已保存到 {文件名}，包含 {len(数据列表)} 条对话")


# 使用示例
if __name__ == "__main__":
    print("=== 数据生成工具 ===")

    # 创建生成器
    生成器 = 数据生成器()

    # 生成数据
    print("\n1. 生成安全日常对话...")
    安全数据 = 生成器.生成对话('安全-日常', 5)

    print("\n2. 生成危险暴力对话...")
    危险数据 = 生成器.生成对话('危险-暴力', 3)

    print("\n3. 生成危险歧视对话...")
    歧视数据 = 生成器.生成对话('危险-歧视', 2)

    # 合并所有数据
    所有数据 = 安全数据 + 危险数据 + 歧视数据

    # 保存
    生成器.保存为文件(所有数据, '../数据/原始数据/生成的数据.txt')

    print("\n=== 生成的数据示例 ===")
    for i, 对话 in enumerate(所有数据[:3]):
        print(f"\n示例 {i + 1}:")
        print(f"  用户: {对话['用户']}")
        print(f"  AI: {对话['AI']}")
        print(f"  标签: {对话['标签']}")
