"""
æ‰‹åŠ¨æ·»åŠ å’Œç®¡ç†æ”»å‡»æ€§æç¤ºè¯æ ·æœ¬çš„å·¥å…·
åœ¨txtæ–‡ä»¶ä¸­æ·»åŠ æ ·æœ¬ï¼Œæ–¹ä¾¿ç¼–è¾‘
"""

import os
from pathlib import Path
import shutil


class æ ·æœ¬ç®¡ç†å·¥å…·:
    def __init__(self):
        self.æ ·æœ¬æ–‡ä»¶ = Path("æ•°æ®/åŸå§‹æ•°æ®/æ”»å‡»æ€§æç¤ºè¯.txt")
        self.æ ·æœ¬å¤‡ä»½ = Path("æ•°æ®/åŸå§‹æ•°æ®/æ”»å‡»æ€§æç¤ºè¯_å¤‡ä»½.txt")

        # ç¡®ä¿ç›®å½•å­˜åœ¨
        self.æ ·æœ¬æ–‡ä»¶.parent.mkdir(parents=True, exist_ok=True)

    def æ˜¾ç¤ºå½“å‰æ ·æœ¬(self):
        """æ˜¾ç¤ºå½“å‰å·²æœ‰çš„æ ·æœ¬"""
        if not self.æ ·æœ¬æ–‡ä»¶.exists():
            print("ğŸ“ è¿˜æ²¡æœ‰æ ·æœ¬æ–‡ä»¶ï¼Œå°†åˆ›å»ºæ–°æ–‡ä»¶")
            return []

        with open(self.æ ·æœ¬æ–‡ä»¶, 'r', encoding='utf-8') as æ–‡ä»¶:
            æ ·æœ¬åˆ—è¡¨ = [è¡Œ.strip() for è¡Œ in æ–‡ä»¶ if è¡Œ.strip()]

        print(f"\nğŸ“Š å½“å‰å…±æœ‰ {len(æ ·æœ¬åˆ—è¡¨)} ä¸ªæç¤ºè¯æ ·æœ¬")

        if æ ·æœ¬åˆ—è¡¨:
            print("\næœ€è¿‘5ä¸ªæ ·æœ¬ï¼š")
            for åºå·, æ ·æœ¬ in enumerate(æ ·æœ¬åˆ—è¡¨[-5:], 1):
                print(f"  {åºå·}. {æ ·æœ¬[:60]}...")

        return æ ·æœ¬åˆ—è¡¨

    def æ·»åŠ æ ·æœ¬(self):
        """æ‰‹åŠ¨æ·»åŠ æ–°æ ·æœ¬"""
        print("\n" + "=" * 50)
        print("ğŸ“ æ·»åŠ æ–°çš„æ”»å‡»æ€§æç¤ºè¯æ ·æœ¬")
        print("æç¤ºï¼šè¾“å…¥ 'å®Œæˆ' ç»“æŸæ·»åŠ ")
        print("=" * 50)

        æ–°æ ·æœ¬åˆ—è¡¨ = []
        ç¼–å· = 1

        while True:
            æ ·æœ¬ = input(f"\næç¤ºè¯ {ç¼–å·}: ").strip()

            if æ ·æœ¬.lower() in ['å®Œæˆ', 'done', 'exit', 'quit']:
                break

            if not æ ·æœ¬:
                print("âš ï¸  è¾“å…¥ä¸ºç©ºï¼Œè·³è¿‡")
                continue

            æ–°æ ·æœ¬åˆ—è¡¨.append(æ ·æœ¬)
            ç¼–å· += 1
            print(f"âœ… å·²æ·»åŠ : {æ ·æœ¬[:50]}...")

        if æ–°æ ·æœ¬åˆ—è¡¨:
            # è¿½åŠ åˆ°æ–‡ä»¶
            with open(self.æ ·æœ¬æ–‡ä»¶, 'a', encoding='utf-8') as æ–‡ä»¶:
                for æ ·æœ¬ in æ–°æ ·æœ¬åˆ—è¡¨:
                    æ–‡ä»¶.write(æ ·æœ¬ + "\n")

            print(f"\nâœ… æˆåŠŸæ·»åŠ  {len(æ–°æ ·æœ¬åˆ—è¡¨)} ä¸ªæ–°æ ·æœ¬")
            print(f"ğŸ“ æ–‡ä»¶ä½ç½®: {self.æ ·æœ¬æ–‡ä»¶}")
        else:
            print("\nâš ï¸  æ²¡æœ‰æ·»åŠ ä»»ä½•æ ·æœ¬")

    def ä»æ–‡ä»¶å¯¼å…¥(self):
        """ä»å…¶ä»–æ–‡ä»¶å¯¼å…¥æ ·æœ¬"""
        æ–‡ä»¶è·¯å¾„ = input("è¯·è¾“å…¥è¦å¯¼å…¥çš„txtæ–‡ä»¶è·¯å¾„: ").strip()

        if not os.path.exists(æ–‡ä»¶è·¯å¾„):
            print(f"âŒ æ–‡ä»¶ä¸å­˜åœ¨: {æ–‡ä»¶è·¯å¾„}")
            return

        try:
            with open(æ–‡ä»¶è·¯å¾„, 'r', encoding='utf-8') as æ–‡ä»¶:
                å¯¼å…¥æ ·æœ¬ = [è¡Œ.strip() for è¡Œ in æ–‡ä»¶ if è¡Œ.strip()]

            if not å¯¼å…¥æ ·æœ¬:
                print("âŒ æ–‡ä»¶æ˜¯ç©ºçš„")
                return

            print(f"ğŸ“¥ ä» {æ–‡ä»¶è·¯å¾„} è¯»å–åˆ° {len(å¯¼å…¥æ ·æœ¬)} ä¸ªæ ·æœ¬")
            print("\nå‰3ä¸ªæ ·æœ¬ï¼š")
            for åºå·, æ ·æœ¬ in enumerate(å¯¼å…¥æ ·æœ¬[:3], 1):
                print(f"  {åºå·}. {æ ·æœ¬[:60]}...")

            ç¡®è®¤ = input("\næ˜¯å¦å¯¼å…¥è¿™äº›æ ·æœ¬? (y/N): ").strip().lower()
            if ç¡®è®¤ == 'y':
                with open(self.æ ·æœ¬æ–‡ä»¶, 'a', encoding='utf-8') as ç›®æ ‡æ–‡ä»¶:
                    for æ ·æœ¬ in å¯¼å…¥æ ·æœ¬:
                        ç›®æ ‡æ–‡ä»¶.write(æ ·æœ¬ + "\n")

                print(f"âœ… æˆåŠŸå¯¼å…¥ {len(å¯¼å…¥æ ·æœ¬)} ä¸ªæ ·æœ¬")

        except Exception as é”™è¯¯:
            print(f"âŒ å¯¼å…¥å¤±è´¥: {é”™è¯¯}")

    def åˆ é™¤æ ·æœ¬(self):
        """åˆ é™¤æŒ‡å®šçš„æ ·æœ¬"""
        æ ·æœ¬åˆ—è¡¨ = self.æ˜¾ç¤ºå½“å‰æ ·æœ¬()

        if not æ ·æœ¬åˆ—è¡¨:
            print("âŒ æ²¡æœ‰æ ·æœ¬å¯åˆ é™¤")
            return

        print("\n" + "=" * 50)
        print("ğŸ—‘ï¸  åˆ é™¤æ ·æœ¬")
        print("è¾“å…¥è¦åˆ é™¤çš„è¡Œå·ï¼ˆå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œå¦‚ï¼š1,3,5ï¼‰")
        print("è¾“å…¥ 'all' åˆ é™¤æ‰€æœ‰æ ·æœ¬")
        print("è¾“å…¥ 'cancel' å–æ¶ˆ")
        print("=" * 50)

        è¾“å…¥ = input("\nè¯·è¾“å…¥: ").strip()

        if è¾“å…¥.lower() == 'cancel':
            print("å–æ¶ˆåˆ é™¤")
            return
        elif è¾“å…¥.lower() == 'all':
            # å¤‡ä»½åŸæ–‡ä»¶
            if self.æ ·æœ¬æ–‡ä»¶.exists():
                shutil.copy2(self.æ ·æœ¬æ–‡ä»¶, self.æ ·æœ¬å¤‡ä»½)
                print(f"ğŸ“¦ å·²å¤‡ä»½åˆ°: {self.æ ·æœ¬å¤‡ä»½}")

            # æ¸…ç©ºæ–‡ä»¶
            with open(self.æ ·æœ¬æ–‡ä»¶, 'w', encoding='utf-8') as æ–‡ä»¶:
                æ–‡ä»¶.write("")

            print("âœ… å·²åˆ é™¤æ‰€æœ‰æ ·æœ¬")
            return

        try:
            # è§£æè¦åˆ é™¤çš„è¡Œå·
            è¡Œå·åˆ—è¡¨ = []
            for éƒ¨åˆ† in è¾“å…¥.split(','):
                éƒ¨åˆ† = éƒ¨åˆ†.strip()
                if éƒ¨åˆ†.isdigit():
                    è¡Œå· = int(éƒ¨åˆ†)
                    if 1 <= è¡Œå· <= len(æ ·æœ¬åˆ—è¡¨):
                        è¡Œå·åˆ—è¡¨.append(è¡Œå· - 1)  # è½¬æ¢ä¸º0-basedç´¢å¼•

            if not è¡Œå·åˆ—è¡¨:
                print("âŒ æ²¡æœ‰è¾“å…¥æœ‰æ•ˆçš„è¡Œå·")
                return

            # æ˜¾ç¤ºè¦åˆ é™¤çš„æ ·æœ¬
            print("\nå°†è¦åˆ é™¤ä»¥ä¸‹æ ·æœ¬ï¼š")
            for è¡Œå· in è¡Œå·åˆ—è¡¨:
                print(f"  {è¡Œå· + 1}. {æ ·æœ¬åˆ—è¡¨[è¡Œå·][:60]}...")

            ç¡®è®¤ = input("\nç¡®è®¤åˆ é™¤? (y/N): ").strip().lower()
            if ç¡®è®¤ != 'y':
                print("å–æ¶ˆåˆ é™¤")
                return

            # ä¿ç•™æœªåˆ é™¤çš„æ ·æœ¬
            ä¿ç•™æ ·æœ¬ = []
            for ç´¢å¼•, æ ·æœ¬ in enumerate(æ ·æœ¬åˆ—è¡¨):
                if ç´¢å¼• not in è¡Œå·åˆ—è¡¨:
                    ä¿ç•™æ ·æœ¬.append(æ ·æœ¬)

            # å†™å›æ–‡ä»¶
            with open(self.æ ·æœ¬æ–‡ä»¶, 'w', encoding='utf-8') as æ–‡ä»¶:
                for æ ·æœ¬ in ä¿ç•™æ ·æœ¬:
                    æ–‡ä»¶.write(æ ·æœ¬ + "\n")

            print(f"âœ… å·²åˆ é™¤ {len(è¡Œå·åˆ—è¡¨)} ä¸ªæ ·æœ¬ï¼Œå‰©ä½™ {len(ä¿ç•™æ ·æœ¬)} ä¸ªæ ·æœ¬")

        except Exception as é”™è¯¯:
            print(f"âŒ åˆ é™¤å¤±è´¥: {é”™è¯¯}")

    def æŸ¥çœ‹æ‰€æœ‰æ ·æœ¬(self):
        """æŸ¥çœ‹æ‰€æœ‰æ ·æœ¬"""
        æ ·æœ¬åˆ—è¡¨ = self.æ˜¾ç¤ºå½“å‰æ ·æœ¬()

        if not æ ·æœ¬åˆ—è¡¨:
            return

        æ¯é¡µæ•°é‡ = 20
        æ€»é¡µæ•° = (len(æ ·æœ¬åˆ—è¡¨) + æ¯é¡µæ•°é‡ - 1) // æ¯é¡µæ•°é‡
        å½“å‰é¡µ = 1

        while True:
            å¼€å§‹ç´¢å¼• = (å½“å‰é¡µ - 1) * æ¯é¡µæ•°é‡
            ç»“æŸç´¢å¼• = min(å¼€å§‹ç´¢å¼• + æ¯é¡µæ•°é‡, len(æ ·æœ¬åˆ—è¡¨))

            print(f"\nğŸ“„ ç¬¬ {å½“å‰é¡µ}/{æ€»é¡µæ•°} é¡µ (å…± {len(æ ·æœ¬åˆ—è¡¨)} ä¸ªæ ·æœ¬)")
            print("-" * 60)

            for ç´¢å¼• in range(å¼€å§‹ç´¢å¼•, ç»“æŸç´¢å¼•):
                print(f"{ç´¢å¼• + 1:3d}. {æ ·æœ¬åˆ—è¡¨[ç´¢å¼•]}")

            print("-" * 60)
            print("å‘½ä»¤: n-ä¸‹ä¸€é¡µ, p-ä¸Šä¸€é¡µ, æ•°å­—-è·³è½¬åˆ°é¡µ, q-è¿”å›")

            å‘½ä»¤ = input("> ").strip().lower()

            if å‘½ä»¤ == 'q':
                break
            elif å‘½ä»¤ == 'n' and å½“å‰é¡µ < æ€»é¡µæ•°:
                å½“å‰é¡µ += 1
            elif å‘½ä»¤ == 'p' and å½“å‰é¡µ > 1:
                å½“å‰é¡µ -= 1
            elif å‘½ä»¤.isdigit():
                é¡µæ•° = int(å‘½ä»¤)
                if 1 <= é¡µæ•° <= æ€»é¡µæ•°:
                    å½“å‰é¡µ = é¡µæ•°
                else:
                    print(f"âŒ é¡µç èŒƒå›´: 1-{æ€»é¡µæ•°}")

    def è¿è¡Œ(self):
        """è¿è¡Œæ ·æœ¬ç®¡ç†å·¥å…·"""
        while True:
            print("\n" + "=" * 50)
            print("ğŸ“ æ”»å‡»æ€§æç¤ºè¯æ ·æœ¬ç®¡ç†å·¥å…·")
            print("=" * 50)

            self.æ˜¾ç¤ºå½“å‰æ ·æœ¬()

            print("\nè¯·é€‰æ‹©æ“ä½œï¼š")
            print("1. ğŸ“ æ·»åŠ æ–°æ ·æœ¬")
            print("2. ğŸ‘€ æŸ¥çœ‹æ‰€æœ‰æ ·æœ¬")
            print("3. ğŸ—‘ï¸  åˆ é™¤æ ·æœ¬")
            print("4. ğŸ“¥ ä»æ–‡ä»¶å¯¼å…¥")
            print("5. ğŸ“ æ‰“å¼€æ ·æœ¬æ–‡ä»¶")
            print("6. â†©ï¸  è¿”å›ä¸»èœå•")

            é€‰æ‹© = input("\nè¯·è¾“å…¥é€‰é¡¹ (1-6): ").strip()

            if é€‰æ‹© == "1":
                self.æ·»åŠ æ ·æœ¬()
            elif é€‰æ‹© == "2":
                self.æŸ¥çœ‹æ‰€æœ‰æ ·æœ¬()
            elif é€‰æ‹© == "3":
                self.åˆ é™¤æ ·æœ¬()
            elif é€‰æ‹© == "4":
                self.ä»æ–‡ä»¶å¯¼å…¥()
            elif é€‰æ‹© == "5":
                # åœ¨PyCharmä¸­æ‰“å¼€æ–‡ä»¶
                if self.æ ·æœ¬æ–‡ä»¶.exists():
                    print(f"ğŸ“ æ–‡ä»¶ä½ç½®: {self.æ ·æœ¬æ–‡ä»¶}")
                    print("è¯·åœ¨PyCharmå·¦ä¾§é¡¹ç›®æ ä¸­åŒå‡»æ‰“å¼€æ­¤æ–‡ä»¶è¿›è¡Œç¼–è¾‘")
                else:
                    print("âŒ æ ·æœ¬æ–‡ä»¶ä¸å­˜åœ¨")
            elif é€‰æ‹© == "6":
                print("è¿”å›ä¸»èœå•")
                break
            else:
                print("âŒ æ— æ•ˆé€‰é¡¹")
